<!DOCTYPE html>
<head>
    <title>Character Sheet</title>
    <link href="res/sheet.css" rel="stylesheet">
    <script src="src/dndbeyond.js"></script>
    <script src="test_json/Jack.jsonp"></script>
</head>
<body>
    <section id="sheet">
        <header id="top-header">
            <h1 id="name">Name</h2>
            <h2 id="race"></h2>
            <h2 id="class"></h2>
        </header>
        <table id="abilityscores">
        </table>
        <div id="spells"></div>
    </section>
    <section id="export">
        <button id="1page_v6">1page_v6</button>
    </section>
    <script>
        const utfCircleOpen =  "○"
        const utfCircleFull =  "●"
        const utfDiamondOpen = "◇"
        const utfDiamondFull = "◈"
        const modString = (mod) => (mod < 0 ? "" : "+") + mod
        document.addEventListener("DOMContentLoaded", () => {
            char = window.character
            document.getElementById("name").textContent = character.name
            document.getElementById("race").textContent = character.race
            document.getElementById("class").textContent = character.class
            const ASTable = document.getElementById("abilityscores")
            const ASRows = ["ast_name", "ast_score", "ast_mod", "ast_skills"]
            // Set up rows (as named above)
            for (let i = 0; i < 4; i++) {
                const as_htmclass = ASRows[i]
                ASRows[i] = document.createElement("tr")
                if (as_htmclass && typeof as_htmclass == 'string') {
                    ASRows[i].classList.add(as_htmclass)
                }
                ASTable.insertAdjacentElement("beforeend", ASRows[i])
            }
            // Fill in each Ability Score column
            for (const ability of abilityScoreNames) {
                // Name
                ASRows[0].insertAdjacentHTML("beforeend", `<th>${ability}</th>`)
                // Score
                const score = character.abilityScores[ability]
                ASRows[1].insertAdjacentHTML("beforeend", `<td>${score}</td>`)
                // Mod
                const mod = Math.floor((score-10)/2)
                ASRows[2].insertAdjacentHTML("beforeend", `<td>${modString(mod)}</td>`)
                // Skills + Saves + etc
                const saveDot = char.proficiencies.saves.includes(ability.toLowerCase()) ? utfDiamondFull : utfDiamondOpen
                let skillBox = `<div>${saveDot} Saves: ${modString(character.saves[ability])}</div>`
                for (const skillName of skillNamesByAbility[ability]) {
                    const skillMod = character.skills[skillName]
                    let isProficient = char.proficiencies.skills.includes(skillName.toLowerCase())
                    let skillDot = isProficient ? utfCircleFull : utfCircleOpen
                    skillBox += `<div>${skillDot} ${skillName}: ${modString(skillMod)}</div>`
                }
                ASRows[3].insertAdjacentHTML("beforeend", `<td>${skillBox}</td>`)
            }
            // Spells
            const spellContain = document.getElementById("spells")
            for (const [i, spells] of Object.entries(character.spells)) {
                if (spells.length == 0) {
                    continue
                }
                const spellLevelDiv = document.createElement("div")
                spellLevelDiv.classList.add("spell-level-" + i)
                spellLevelDiv.classList.add("spell-level")
                const spellLevelHeader = document.createElement("h2")
                spellLevelHeader.textContent = "Level " + i
                spellLevelDiv.insertAdjacentElement("beforeend", spellLevelHeader)
                for (const spell of spells) {
                    const spellDiv = document.createElement("div")
                    spellDiv.classList.add("spell")
                    spellDiv.textContent = spell.name
                    spellLevelDiv.insertAdjacentElement("beforeend", spellDiv)
                }
                spellContain.insertAdjacentElement("beforeend", spellLevelDiv)
            }
            
            // Export
            export_section = document.getElementById("export")
            export_section.innerHTML = "<span>Export: </span>"
            const sheet_names = ["1page_v6", "halfpage_double_color", "standard"];
            for (const sheet_name of sheet_names) {
                const sheet_button = document.createElement("button")
                sheet_button.textContent = sheet_name + ".pdf"
                sheet_button.addEventListener("click", () => {
                    import("./src/pdftest.js").then((module) => {
                        module.fillForm(`pdfs/${sheet_name}/sheet.pdf`, `pdfs/${sheet_name}/sheet.json`, character)
                    })
                })
                document.getElementById("export").insertAdjacentElement("beforeend", sheet_button)
            }
            // JSON Exports
            const jsonExport = (download = false) => {
                // Convert the JSON object to a formatted string
                const replacer = (k, v) => k.match("dndb_") ? null : v;
                const jsonData = JSON.stringify(char, replacer, 2);
                // Create a Blob object with the JSON data and set the mime type
                const blob = new Blob([jsonData], {type: "application/json"});
                // Create a URL for the Blob object
                const url = URL.createObjectURL(blob);
                if (download) {
                    // Create a link element and click it to download the file
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = char.name + ".char.json";
                    link.click();
                } else {
                    // Open a new window and set the Content-Type header to application/json
                    const newPage = window.open(url, '_blank');
                    const xhr = new XMLHttpRequest();
                    xhr.open('HEAD', url, true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send();
                }
            }
            // .char.json
            const jsonExportButton = document.createElement("button")
            jsonExportButton.textContent = "char.json"
            jsonExportButton.addEventListener("click", () => jsonExport(true))
            export_section.insertAdjacentElement("beforeend", jsonExportButton)
            // new tab
            const newPageButton = document.createElement("button")
            newPageButton.textContent = "open in new tab"
            newPageButton.addEventListener("click", () => jsonExport(false))
            export_section.insertAdjacentElement("beforeend", newPageButton)
        })
    </script>
</body>