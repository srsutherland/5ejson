<!DOCTYPE html>
<head>
    <title>Character Sheet</title>
    <link href="res/sheet.css" rel="stylesheet">
    <link rel="icon" href="res/favicon.png">
    <script src="src/constants.js"></script>
    <script src="src/dndbeyond.js"></script>
    <script src="test_json/Jack.jsonp"></script>
</head>
<body>
    <section id="sheet">
        <header id="top-header">
            <h1 id="name">Name</h2>
            <h2 id="race"></h2>
            <h2 id="class"></h2>
        </header>
        <table id="abilityscores">
        </table>
        <div id="spells"></div>
    </section>
    <section id="export">
        <button id="1page_v6">1page_v6</button>
    </section>
    <section id="import">
        <button id="import-5ejson">Import 5ejson</button>
        <button id="import-dndb">Import D&D Beyond</button>
        <!-- dropdown for loading sample chars 
            Jack.json
            kepaniGinger\Artificer_Yllakalyn_Fasharash.json
            kepaniGinger\Cleric_Cookie_Porridgepot.json
            kepaniGinger\Cleric_Narith.json
            kepaniGinger\Monk_Cleo.json
            kepaniGinger\multiWarlockFighterSorcerer_Sharver_Greenbottle.json
            kepaniGinger\Paladin_Qivira.json
            kepaniGinger\Wizard_Kaitvian.json
            OgPhoen1xWolf\Bard_Azarrus.json
            OgPhoen1xWolf\Bard_Lucius_Maverick.json
            OgPhoen1xWolf\multiBardWizard_Klaus.json
            OgPhoen1xWolf\Druid_Karn_Orvic
        -->
        <select id="sample-chars">
            <option value="Jack.json">Jack (default)</option>
            <option value="kepaniGinger/Artificer_Yllakalyn_Fasharash.json">Artificer_Yllakalyn_Fasharash</option>
            <option value="kepaniGinger/Cleric_Cookie_Porridgepot.json">Cleric_Cookie_Porridgepot</option>
            <option value="kepaniGinger/Cleric_Narith.json">Cleric_Narith</option>
            <option value="kepaniGinger/Monk_Cleo.json">Monk_Cleo</option>
            <option value="kepaniGinger/multiWarlockFighterSorcerer_Sharver_Greenbottle.json">multiWarlockFighterSorcerer_Sharver_Greenbottle</option>
            <option value="kepaniGinger/Paladin_Qivira.json">Paladin_Qivira</option>
            <option value="kepaniGinger/Wizard_Kaitvian.json">Wizard_Kaitvian</option>
            <option value="OgPhoen1xWolf/Bard_Azarrus.json">Bard_Azarrus</option>
            <option value="OgPhoen1xWolf/Bard_Lucius_Maverick.json">Bard_Lucius_Maverick</option>
            <option value="OgPhoen1xWolf/Druid_Karn_Orvic.json">Druid_Karn_Orvic</option>
            <option value="OgPhoen1xWolf/multiBardWizard_Klaus.json">multiBardWizard_Klaus</option>
        </select>
        <button id="load-sample-char">Load Sample Char</button>
    </section>
    <div id="debug"><pre id="log"></pre></div>
    <script>
        const utfCircleOpen =  "◌"
        const utfCircleFull =  "●"
        const utfCircleExtra = "☀"
        const utfCircleHalf =  "○"
        const utfDiamondOpen = "◇"
        const utfDiamondFull = "◈"
        const modString = (mod) => (mod < 0 ? "" : "+") + mod
        const onCharLoaded = () => {
            char = window.character
            document.getElementById("name").textContent = character.name
            // Link to D&D Beyond
            if (character.dndb_data?.id) {
                document.getElementById("name").insertAdjacentHTML("beforeend", `
                    <a 
                        href="https://www.dndbeyond.com/characters/${character.dndb_data.id}" 
                        style="margin-left: .5em; font-size: 16px; color: grey; text-decoration: none;"
                    >
                        <img src="https://www.google.com/s2/favicons?sz=16&amp;domain=www.dndbeyond.com">🡥
                    </a>
                `)
            }
            document.getElementById("race").textContent = character.race
            document.getElementById("class").textContent = character.class
            const ASTable = document.getElementById("abilityscores")
            ASTable.innerHTML = ""
            const ASRows = ["ast_name", "ast_score", "ast_mod", "ast_skills"]
            // Set up rows (as named above)
            for (let i = 0; i < 4; i++) {
                const as_htmclass = ASRows[i]
                ASRows[i] = document.createElement("tr")
                if (as_htmclass && typeof as_htmclass == 'string') {
                    ASRows[i].classList.add(as_htmclass)
                }
                ASTable.insertAdjacentElement("beforeend", ASRows[i])
            }
            // Fill in each Ability Score column
            for (const ability of abilityScoreNames) {
                // Name
                ASRows[0].insertAdjacentHTML("beforeend", `<th>${ability}</th>`)
                // Score
                const score = character.abilityScores[ability]
                ASRows[1].insertAdjacentHTML("beforeend", `<td>${score}</td>`)
                // Mod
                const mod = Math.floor((score-10)/2)
                ASRows[2].insertAdjacentHTML("beforeend", `<td>${modString(mod)}</td>`)
                // Skills + Saves + etc
                const saveDot = char.proficiencies.saves.includes(ability.toLowerCase()) ? utfDiamondFull : utfDiamondOpen
                let skillBox = `<div>${saveDot} Saves: ${modString(character.saves[ability])}</div>`
                for (const skillName of skillNamesByAbility[ability]) {
                    const skillMod = character.skills[skillName]
                    const profKey = skillName.toLowerCase().replace(/ /g, "-")
                    const isProficient = char.proficiencies.skills.includes(profKey)
                    const hasExpertise = char.expertise.skills.includes(profKey)
                    const skillDot = isProficient ? 
                        (hasExpertise ? utfCircleExtra : utfCircleFull) : 
                        (char.halfProf ? utfCircleHalf : utfCircleOpen)
                    skillBox += `<div>${skillDot} ${skillName}: ${modString(skillMod)}</div>`
                }
                ASRows[3].insertAdjacentHTML("beforeend", `<td>${skillBox}</td>`)
            }
            // Spells
            const spellContain = document.getElementById("spells")
            spellContain.innerHTML = ""
            for (const [i, spells] of Object.entries(character.spells)) {
                if (spells.length == 0) {
                    continue
                }
                const spellLevelDiv = document.createElement("div")
                spellLevelDiv.classList.add("spell-level-" + i)
                spellLevelDiv.classList.add("spell-level")
                const spellLevelHeader = document.createElement("h2")
                spellLevelHeader.textContent = "Level " + i
                spellLevelDiv.insertAdjacentElement("beforeend", spellLevelHeader)
                for (const spell of spells) {
                    const spellDiv = document.createElement("div")
                    spellDiv.classList.add("spell")
                    spellDiv.textContent = spell.name
                    spellLevelDiv.insertAdjacentElement("beforeend", spellDiv)
                }
                spellContain.insertAdjacentElement("beforeend", spellLevelDiv)
            }
            
            // PDF Exports
            export_section = document.getElementById("export")
            export_section.innerHTML = "<span>Export: </span>"
            const sheet_names = ["1page_v6", "halfpage_double_color", "standard"];
            for (const sheet_name of sheet_names) {
                const sheet_button = document.createElement("button")
                const log_elem = document.getElementById("log")
                sheet_button.textContent = sheet_name + ".pdf"
                sheet_button.addEventListener("click", () => {
                    log_elem.textContent = "importing pdf.js..."
                    import("./src/pdf.js").then((module) => {
                        module.fillForm(
                            `pdfs/${sheet_name}/sheet.pdf`, 
                            `pdfs/${sheet_name}/sheet.json`, 
                            character,
                            (str) => { log_elem.textContent = str }
                        )
                    }).catch((err) => {
                        log_elem.textContent = err
                    })
                })
                document.getElementById("export").insertAdjacentElement("beforeend", sheet_button)
            }
            // JSON Exports
            const jsonExport = (download = false) => {
                // Convert the JSON object to a formatted string
                const replacer = (k, v) => k.match("dndb_") ? null : v;
                const jsonData = JSON.stringify(char, replacer, 2);
                // Create a Blob object with the JSON data and set the mime type
                const blob = new Blob([jsonData], {type: "application/json"});
                // Create a URL for the Blob object
                const url = URL.createObjectURL(blob);
                if (download) {
                    // Create a link element and click it to download the file
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = char.name + ".char.json";
                    link.click();
                } else {
                    // Open a new window and set the Content-Type header to application/json
                    const newPage = window.open(url, '_blank');
                    const xhr = new XMLHttpRequest();
                    xhr.open('HEAD', url, true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send();
                }
            }
            // .char.json
            const jsonExportButton = document.createElement("button")
            jsonExportButton.textContent = "char.json"
            jsonExportButton.addEventListener("click", () => jsonExport(true))
            export_section.insertAdjacentElement("beforeend", jsonExportButton)
            // new tab
            const newPageButton = document.createElement("button")
            newPageButton.textContent = "json in new tab"
            newPageButton.addEventListener("click", () => jsonExport(false))
            export_section.insertAdjacentElement("beforeend", newPageButton)
        }
        document.addEventListener("DOMContentLoaded", onCharLoaded)

        // Hook up import buttons
        // 5ejson
        document.getElementById("import-5ejson").addEventListener("click", () => {
            const fileInput = document.createElement("input")
            fileInput.type = "file"
            fileInput.accept = ".json"
            fileInput.addEventListener("change", () => {
                const file = fileInput.files[0]
                const reader = new FileReader()
                reader.addEventListener("load", () => {
                    const json = JSON.parse(reader.result)
                    character = json
                    char = json
                    onCharLoaded()
                })
                reader.readAsText(file)
            })
            fileInput.click()
        })
        // dndb
        document.getElementById("import-dndb").addEventListener("click", () => {
            const fileInput = document.createElement("input")
            fileInput.type = "file"
            fileInput.accept = ".json"
            fileInput.addEventListener("change", () => {
                const file = fileInput.files[0]
                const reader = new FileReader()
                reader.addEventListener("load", () => {
                    const json = JSON.parse(reader.result)
                    char = dndbeyond_json_parse(json)
                    onCharLoaded()
                })
                reader.readAsText(file)
            })
            fileInput.click()
        })
        // sample char
        document.getElementById("load-sample-char").addEventListener("click", () => {
            const log_elem = document.getElementById("log")
            const option = document.getElementById("sample-chars").value
            log_elem.textContent = "fetching " + option + "..."
            fetch("test_json/" + option).then(r => r.json()).then(json => {
                try {
                    char = dndbeyond_json_parse(json)
                    onCharLoaded()
                    log_elem.textContent = ""
                } catch (err) {
                    log_elem.textContent = err
                    return
                }
            }).catch(err => {
                log_elem.textContent = err
            })
        })


        // Debug
        function fill_spells() {
            // For testing pdf spell fields, fill in all spells as "lvl - num"
            char.spells = Object.keys(char.spells).map(
                l => Object.keys(Array(15).fill(''))
                .map(i => Object.fromEntries([["name", `${l} - ${i}`]]))
            )
        }
    </script>
</body>